---
title: "内在能力建模"
author: "Ruifu Kang & Yirou Niu"
date: "2024-12-26"
format: "pptx"
---

# 建模步骤
## 数据初步清洗

1. 读取并合并数据
2. 变量重命名：内在能力及其相关变量，包括出生年份、性别等都重命名
3. 年龄数据清洗：去掉非老年人的个体之后9982人

## 内在能力赋值

### 1.  运动
- 2.5米步行速度≥ 1米/秒得1分；
```{mermaid}
flowchart TD
    subgraph s1["步行测试"]
        A["计算步行测试时间"] --> B["判断两次步行测试时间是否均为993"]
        B -->|是| C["步行测试时间得分为0"]
        B -->|否| D["判断两次步行测试时间是否都为999或NA"]
        D -->|是| E["判断步行测试未完成原因"]
        E -->|原因是4或6| F["步行测试时间得分为0"]
        E -->|其他原因或NA| G["步行测试时间得分为NA"]
        D -->|否| H["判断步行测试使用辅具情况"]
        H -->|未使用辅具| I["计算两次步行时间测试的最大值"]
        I -->|步行速度 >= 1米/秒| J["步行测试时间得分为1"]
        I -->|步行速度 < 1米/秒| K["步行测试时间得分为0"]
        I -->|NA| L["步行测试时间得分为NA"]
        H -->|使用辅具| M["步行测试时间得分为0"]
        H -->|NA| N["步行测试时间得分为NA（应该不会出现，怕有没想到的情况）"]
    end

    subgraph s2["坐起测试"]
        A1["坐起测试评分"] --> B1["坐起测试是否完成是否为993"]
        B1 -->|是| C1["得分=0"]
        B1 -->|否| D1["是否为999或NA"]
        D1 -->|是| E1["判断未完成原因"]
        E1 -->|含4或6| F1["得分=0"]
        E1 -->|其他或NA| G1["得分=NA"]
        D1 -->|否| H1["是否完成测试"]
        H1 -->|完成| I1["是否使用手臂？"]
        I1 -->|使用手臂| M1["得分=0"]
        I1 -->|未使用手臂| L1["判断完成时间"]
        I1 -->|NA| P1["得分=NA"]
        L1 -->|"≤12秒"| O1["得分=1"]
        L1 -->|">12秒"| N1["得分=0"]
        L1 -->|NA| Q1["得分=NA"]
        H1 -->|未完成| J1["得分=0"]
        H1 -->|NA| K1["得分=NA"]
    end
    
    s2 --> n1["计算运动维度总分"]
    s1 --> n1
```
- 重复坐下5次≤12秒得1分；

- 平衡：3个10秒完成2个及以上得1分。


- 满分3分
### 2.  认知：
- 情景记忆（基于延迟回忆得分）：0-10分；
- 减7测试：5分；
- 日期、月份、年份和季节：5分；
- 绘画：1分。
- 满分21分 
- 进一步：范围18-20：得3分；范围14-17：得2分；范围7-13：得1分；范围0-6：得0分。
- 满分3分
```{mermaid}

```

### 3. 心理
- CES-D评分为0到9分：得1分；
- 总睡眠时间在5到10.5小时之间，得1分；
- 睡眠质量：一周内睡眠不安的频率0到2天之间得1分。
- 满分3分

### 4.  感官
- 听力回答非常好、好、一般：得1分；
- 视力回答非常好、好、一般：得1分（远和近两项）
- 满分3分

### 5.  活力
- 握力：男性≥ 35kg得1分，女性≥ 25kg得1分；
- FEV：男性≥ 400得1分，女性≥ 290得1分;
- 血红蛋白：男性≥ 120g/L得1分，女性≥ 110g/L得1分。
- 满分3分

## 内在能力筛选
- 根据内在能力计算情况筛选出覆盖内在能力指标范围大于100%的个体
- 保存筛选后的数据到一个新的数据框中  

## 自变量筛选与清洗
### 经验筛选
### 算法筛选
- boruta算法筛选
- 
## 数据拆分
- 
## 模型构建

## 模型验证

# 代码
## 读取并合并数据
```{r 读取并合并数据}
# 安装并加载所需要的包
if (!requireNamespace("haven", quietly = TRUE)) {
    install.packages("haven")
}
if (!requireNamespace("dplyr", quietly = TRUE)) {
    install.packages("dplyr")
}
if (!requireNamespace("ggplot2", quietly = TRUE)) {
    install.packages("ggplot2")
}
library(haven)
library(dplyr)
library(ggplot2)

# 读取并合并数据
files <- list.files("data_raw/2015/self",
    pattern = "\\.dta$",
    full.names = TRUE
)
data_list <- lapply(files, read_dta)
my_data_raw <- Reduce(function(x, y) full_join(x, y, by = "ID"), data_list)
print(my_data_raw)
```
## 变量重命名
```{r 变量重命名}
# 变量重命名
my_data_rename <- my_data_raw %>%
    rename(
        # 基本信息重命名
        id_birth_year = ba004_w3_1,   # ID出生年份
        actual_birth_year = ba002_1,  # 实际出生年份 
        death = died,                 # 是否死亡
        gender = ba000_w2_3,          # 性别

        # 内在能力运动维度重命名
        balance_test_affected = pd001,  # 是否影响完成平衡测试
        understand_and_willing_semi_tandem = pd002,  # 是否明白且愿意参加双脚前后半站立测试
        stand_test_semi_tandem_reason_1 = qd001s1,  # 未完成双脚半前后站立测试的第一个原因
        stand_test_semi_tandem_reason_2 = qd001s2,  # 未完成双脚半前后站立测试的第二个原因
        stand_test_semi_tandem_reason_3 = qd001s3,  # 未完成双脚半前后站立测试的第三个原因
        stand_test_semi_tandem_reason_4 = qd001s4,  # 未完成双脚半前后站立测试的第四个原因
        stand_test_semi_tandem_reason_5 = qd001s5,  # 未完成双脚半前后站立测试的第五个原因
        stand_test_semi_tandem_reason_6 = qd001s6,  # 未完成双脚半前后站立测试的第六个原因
        stand_test_semi_tandem_reason_7 = qd001s7,  # 未完成双脚半前后站立测试的第七个原因
        stand_test_semi_tandem_reason_8 = qd001s8,  # 未完成双脚半前后站立测试的第八个原因
        stand_test_semi_tandem_reason_other = qd001s97,  # 未完成双脚半前后站立测试的其他原因
        stand_test_semi_tandem = qd002,  # 是否完成双脚半前后站立测试

        understand_and_willing_tandem = pe002,  # 是否明白且愿意参加双脚一条线站立测试
        stand_test_tandem_reason_1 = qe001s1,  # 未完成双脚一条线站立测试的第一个原因
        stand_test_tandem_reason_2 = qe001s2,  # 未完成双脚一条线站立测试的第二个原因
        stand_test_tandem_reason_3 = qe001s3,  # 未完成双脚一条线站立测试的第三个原因
        stand_test_tandem_reason_4 = qe001s4,  # 未完成双脚一条线站立测试的第四个原因
        stand_test_tandem_reason_5 = qe001s5,  # 未完成双脚一条线站立测试的第五个原因
        stand_test_tandem_reason_6 = qe001s6,  # 未完成双脚一条线站立测试的第六个原因
        stand_test_tandem_reason_7 = qe001s7,  # 未完成双脚一条线站立测试的第七个原因
        stand_test_tandem_reason_8 = qe001s8,  # 未完成双脚一条线站立测试的第八个原因
        stand_test_tandem_reason_other = qe001s97,  # 未完成双脚一条线站立测试的其他原因
        stand_test_tandem = qe002,       # 双脚一条线站立测试
        stand_test_tandem_time = qe003,  # 双脚一条线站立测试时间

        understand_and_willing_feet_together = pf001,  # 是否明白且愿意参加双脚并拢站立测试
        stand_test_feet_together_reason_1 = qf001s1,  # 未完成双脚并拢站立测试的第一个原因
        stand_test_feet_together_reason_2 = qf001s2,  # 未完成双脚并拢站立测试的第二个原因
        stand_test_feet_together_reason_3 = qf001s3,  # 未完成双脚并拢站立测试的第三个原因
        stand_test_feet_together_reason_4 = qf001s4,  # 未完成双脚并拢站立测试的第四个原因
        stand_test_feet_together_reason_5 = qf001s5,  # 未完成双脚并拢站立测试的第五个原因
        stand_test_feet_together_reason_6 = qf001s6,  # 未完成双脚并拢站立测试的第六个原因
        stand_test_feet_together_reason_7 = qf001s7,  # 未完成双脚并拢站立测试的第七个原因
        stand_test_feet_together_reason_8 = qf001s8,  # 未完成双脚并拢站立测试的第八个原因
        stand_test_feet_together_reason_other = qf001s97,  # 未完成双脚并拢站立测试的其他原因
        stand_test_feet_together = qf002, # 双脚并拢站立测试

        walk_test_reason_1 = qg001s1,  # 未完成步行测试的第一个原因
        walk_test_reason_2 = qg001s2,  # 未完成步行测试的第二个原因
        walk_test_reason_3 = qg001s3,  # 未完成步行测试的第三个原因
        walk_test_reason_4 = qg001s4,  # 未完成步行测试的第四个原因
        walk_test_reason_5 = qg001s5,  # 未完成步行测试的第五个原因
        walk_test_reason_6 = qg001s6,  # 未完成步行测试的第六个原因
        walk_test_reason_7 = qg001s7,  # 未完成步行测试的第七个原因
        walk_test_reason_8 = qg001s8,  # 未完成步行测试的第八个原因
        walk_test_reason_other = qg001s97,  # 未完成步行测试的其他原因
        walk_time_first = qg002,       # 步行测试时间1
        walk_time_second = qg003,      # 步行测试时间2
        walk_test_aid = qg005,       # 步行测试使用辅具情况

        sit_stand_test_reason_1 = qh001s1,  # 未完成五次坐下起来测试的第一个原因
        sit_stand_test_reason_2 = qh001s2,  # 未完成五次坐下起来测试的第二个原因
        sit_stand_test_reason_3 = qh001s3,  # 未完成五次坐下起来测试的第三个原因
        sit_stand_test_reason_4 = qh001s4,  # 未完成五次坐下起来测试的第四个原因
        sit_stand_test_reason_5 = qh001s5,  # 未完成五次坐下起来测试的第五个原因
        sit_stand_test_reason_6 = qh001s6,  # 未完成五次坐下起来测试的第六个原因
        sit_stand_test_reason_7 = qh001s7,  # 未完成五次坐下起来测试的第七个原因
        sit_stand_test_reason_8 = qh001s8,  # 未完成五次坐下起来测试的第八个原因
        sit_stand_test_reason_other = qh001s97,  # 未完成五次坐下起来测试的其他原因
        sit_stand_test_completed = qh002,  # 是否完成五次坐下起来测试
        sit_stand_test_time = qh003,  # 完成五次坐下起来测试的时间
        sit_stand_test_arm_use = qh007,  # 坐起测试中使用手臂的情况

        

        # 内在能力认知维度重命名
        # 内在能力认知维度重命名
        proxy_answer = db032,          # 是否由别人代答
        recall_word_1 = dc006s1,       # 回忆词汇1
        recall_word_2 = dc006s2,       # 回忆词汇2
        recall_word_3 = dc006s3,       # 回忆词汇3
        recall_word_4 = dc006s4,       # 回忆词汇4
        recall_word_5 = dc006s5,       # 回忆词汇5
        recall_word_6 = dc006s6,       # 回忆词汇6
        recall_word_7 = dc006s7,       # 回忆词汇7
        recall_word_8 = dc006s8,       # 回忆词汇8
        recall_word_9 = dc006s9,       # 回忆词汇9
        recall_word_10 = dc006s10,     # 回忆词汇10
        recall_none = dc006s11,        # 是否一个都没回忆起来
        recall_refused = dc006s12,     # 是否拒绝回忆

        recall_year = dc001s1,         # 回忆年份
        recall_month = dc001s2,        # 回忆月份
        recall_day = dc001s3,          # 回忆日期
        recall_weekday = dc002,        # 回忆星期
        recall_season = dc003,         # 回忆季节

        subtraction_test_1 = dc019,    # 减法测试1
        subtraction_test_2 = dc020,    # 减法测试2
        subtraction_test_3 = dc021,    # 减法测试3
        subtraction_test_4 = dc022,    # 减法测试4
        subtraction_test_5 = dc023,    # 减法测试5
        subtraction_tool_use = dc024,  # 是否使用工具计算

        drawing_test = dc025,          # 画图测试


        # 内在能力心理维度重命名
        depression_scale_1 = dc009,    # 心理量表问题1
        depression_scale_2 = dc010,    # 心理量表问题2
        depression_scale_3 = dc011,    # 心理量表问题3
        depression_scale_4 = dc012,    # 心理量表问题4
        depression_scale_5 = dc013,    # 心理量表问题5
        depression_scale_6 = dc014,    # 心理量表问题6
        depression_scale_7 = dc016,    # 心理量表问题7
        depression_scale_8 = dc017,    # 心理量表问题8
        depression_scale_9 = dc018,    # 心理量表问题9
        night_sleep_time = da049,      # 夜晚睡眠时间
        poor_sleep_frequency = dc015,  # 睡眠不佳频率
        nap_time = da050,              # 午睡时间

        # 内在能力感官维度重命名
        wearing_glasses = da032,       # 是否佩戴眼镜
        far_vision = da033,            # 看远处视力情况
        near_vision = da034,           # 看近处视力情况
        hearing_aid = da038,           # 是否佩戴助听器
        hearing_status = da039,        # 听力情况
        
        
        # 内在能力活力维度重命名
        grip_test_reason_1 = qc001s1,  # 未完成握力测量的第一个原因
        grip_test_reason_2 = qc001s2,  # 未完成握力测量的第二个原因
        grip_test_reason_3 = qc001s3,  # 未完成握力测量的第三个原因
        grip_test_reason_4 = qc001s4,  # 未完成握力测量的第四个原因
        grip_test_reason_5 = qc001s5,  # 未完成握力测量的第五个原因
        grip_test_reason_6 = qc001s6,  # 未完成握力测量的第六个原因
        grip_test_reason_7 = qc001s7,  # 未完成握力测量的第七个原因
        grip_test_reason_8 = qc001s8,  # 未完成握力测量的第八个原因
        grip_test_reason_other = qc001s97,  # 未完成握力测量的其他原因
        left_hand_grip_1 = qc003,      # 第一次左手握力测量
        right_hand_grip_1 = qc004,     # 第一次右手握力测量
        left_hand_grip_2 = qc005,      # 第二次左手握力测量
        right_hand_grip_2 = qc006,     # 第二次右手握力测量

        breath_test_reason_1 = qb001s1,  # 未完成呼吸测试的第一个原因
        breath_test_reason_2 = qb001s2,  # 未完成呼吸测试的第二个原因
        breath_test_reason_3 = qb001s3,  # 未完成呼吸测试的第三个原因
        breath_test_reason_4 = qb001s4,  # 未完成呼吸测试的第四个原因
        breath_test_reason_5 = qb001s5,  # 未完成呼吸测试的第五个原因
        breath_test_reason_6 = qb001s6,  # 未完成呼吸测试的第六个原因
        breath_test_reason_7 = qb001s7,  # 未完成呼吸测试的第七个原因
        breath_test_reason_8 = qb001s8,  # 未完成呼吸测试的第八个原因
        breath_test_reason_other = qb001s97,  # 未完成呼吸测试的其他原因
        breath_test_1 = qb002,         # 第一次呼吸功能测定
        breath_test_2 = qb003,         # 第二次呼吸功能测定
        breath_test_3 = qb004,         # 第三次呼吸功能测定

        hemoglobin = bl_hgb          # 血红蛋白含量
    )
# 导出包含所有重命名列的数据
renamed_columns <- names(my_data_rename)
original_columns <- names(my_data_raw)
renamed_only_columns <- setdiff(renamed_columns, original_columns)
my_data_renamed_only <- my_data_rename %>%
    select(all_of(renamed_only_columns))
write.csv(my_data_renamed_only, "renamed_data.csv", row.names = FALSE)

```
## 年龄数据清洗
```{r 年龄数据清洗}
# 去除实际出生年份和ID出生年份同时缺失的数据
my_data_year_na <- my_data_rename %>%
    filter(!(is.na(actual_birth_year) & is.na(id_birth_year)))

# 计算年龄值
my_data_age <- my_data_year_na %>%
    mutate(age = 2015 - coalesce(actual_birth_year, id_birth_year))

# 年龄清洗
my_data_elder <- my_data_age %>%
    filter(age >= 60)
    # 输出现在总共多少人
total_individuals <- nrow(my_data_elder)
print(paste("总共人数:", total_individuals))
my_data_wash <- my_data_elder

```
## 内在能力分数计算
### 运动维度计算（无误）
```{r 运动维度计算}
# 计算步行测试时间（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_walk_time = case_when(
            walk_time_first == 993 & walk_time_second == 993 ~ 0,
            (is.na(walk_time_first) & is.na(walk_time_second)) | (walk_time_first == 999 & walk_time_second == 999) | (is.na(walk_time_first) & walk_time_second == 999) | (walk_time_first == 999 & is.na(walk_time_second)) ~ case_when(
                rowSums(select(., starts_with("walk_test_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("walk_test_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            TRUE ~ case_when(
                walk_test_aid == 1 ~ if_else(2.5 / pmin(walk_time_first, walk_time_second, na.rm = TRUE) >= 1, 1, 0),
                walk_test_aid %in% c(2, 3, 4, 97) ~ 0,
                TRUE ~ NA_real_
            )
        )
    )

# 统计最终步行时间分数不同取值的数量，包括NA
table(my_data_wash$final_walk_time, useNA = "always")

# 计算平衡分数
# 计算双脚半前后站立时间分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_semi_tandem_time = case_when(
            stand_test_semi_tandem %in% c(993) ~ 0, # 因为存在这个变量为993但是原因没有4和6的情况，所以这种直接赋值为0了，按这个变量优先
            stand_test_semi_tandem %in% c(999, NA) ~ case_when(
                rowSums(select(., starts_with("stand_test_semi_tandem_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("stand_test_semi_tandem_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            stand_test_semi_tandem == 1 ~ 1,
            stand_test_semi_tandem == 5 ~ 0,
            TRUE ~ NA_real_
        )
    )


# 统计双脚半前后站立时间分数不同取值的数量，包括NA
table(my_data_wash$final_semi_tandem_time, useNA = "always")


# 计算双脚前后一条线站立时间分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_tandem_time = case_when(
            stand_test_tandem %in% c(993) ~ 0, # 因为存在这个变量为993但是原因没有4和6的情况，所以这种直接赋值为0了，按这个变量优先
            stand_test_tandem %in% c(999, NA) ~ case_when(
                rowSums(select(., starts_with("stand_test_tandem_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("stand_test_tandem_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            stand_test_tandem == 1 ~ 1,
            stand_test_tandem == 5 ~ if_else(stand_test_tandem_time >= 10, 1, 0),
            TRUE ~ NA_real_
        )
    )
# 统计双脚前后一条线站立分数不同取值的数量，包括NA
table(my_data_wash$final_tandem_time, useNA = "always")


# 计算双脚并拢站立时间分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_feet_together_time = case_when(
            stand_test_feet_together %in% c(993) ~ 0,
            stand_test_feet_together %in% c(999, NA) ~ case_when(
                rowSums(select(., starts_with("stand_test_feet_together_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("stand_test_feet_together_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            stand_test_feet_together == 1 ~ 1,
            stand_test_feet_together == 5 ~ 0,
            TRUE ~ NA_real_
        )
    )

# 统计双脚并拢站立分数不同取值的数量，包括NA
table(my_data_wash$final_feet_together_time, useNA = "always")

# 计算最终平衡得分（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_balance_score = case_when(
            rowSums(select(., final_semi_tandem_time, final_tandem_time, final_feet_together_time) == 1, na.rm = TRUE) >= 2 ~ 1,
            rowSums(is.na(select(., final_semi_tandem_time, final_tandem_time, final_feet_together_time))) >= 2 ~ NA_real_,
            rowSums(is.na(select(., final_semi_tandem_time, final_tandem_time, final_feet_together_time))) == 1 &
            rowSums(select(., final_semi_tandem_time, final_tandem_time, final_feet_together_time) == 1, na.rm = TRUE) == 1 &
            rowSums(select(., final_semi_tandem_time, final_tandem_time, final_feet_together_time) == 0, na.rm = TRUE) == 1 ~ NA_real_,
            TRUE ~ 0
        )
    )
# 统计最终平衡得分不同取值的数量，包括NA
table(my_data_wash$final_balance_score, useNA = "always")

# 计算坐起测试时间(无误)
my_data_wash <- my_data_wash %>%
    mutate(
        final_sit_stand_time = case_when(
            sit_stand_test_completed %in% c(993) ~ 0,
            sit_stand_test_completed %in% c(999, NA) ~ case_when(
                rowSums(select(., starts_with("sit_stand_test_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("sit_stand_test_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            sit_stand_test_completed == 1 ~ case_when(
                sit_stand_test_arm_use == 1 ~ 0,
                sit_stand_test_arm_use == 5 ~ case_when( # 这个地方数据和代码本否是5，但questionare是1，弄了半天
                    sit_stand_test_time <= 12 ~ 1,
                    sit_stand_test_time > 12 ~ 0,
                    TRUE ~ NA_real_
                    ),
                TRUE ~ NA_real_ 
            ),
            sit_stand_test_completed == 5 ~ 0,
            TRUE ~ NA_real_
        )
    )

# 查看起坐测试时间分数不同取值的数量，包括NA
table(my_data_wash$final_sit_stand_time, useNA = "always")

# 计算运动维度总分（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_physical_score = rowSums(select(., final_walk_time, final_balance_score, final_sit_stand_time), na.rm = FALSE)
    )

# 查看运动维度总分不同取值的数量，包括NA
table(my_data_wash$final_physical_score, useNA = "always")

# 导出运动维度所有变量和ID，去除其他所有变量，导出一个csv
required_columns <- c(
    "ID", "final_walk_time", "final_semi_tandem_time", "final_tandem_time", "final_feet_together_time", "final_balance_score", "final_sit_stand_time", "final_physical_score"
)
my_data_physical <- my_data_wash %>%
    select(all_of(required_columns))

write.csv(my_data_physical, "physical_dimension_data.csv", row.names = FALSE)
```
### 认知维度计算（无误）
```{r 认知维度计算}
# 计算最终回忆分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_recall_score = case_when(
            !is.na(recall_refused) ~ NA_real_,
            !is.na(recall_none) ~ 0,
            TRUE ~ rowSums(select(., starts_with("recall_word_")) %>% mutate_all(~ if_else(!is.na(.), 1, 0)), na.rm = TRUE)
        )
    )

# 统计最终回忆分数不同取值的数量，包括NA
table(my_data_wash$final_recall_score, useNA = "always")

# 统计是否使用计算工具
table(my_data_wash$subtraction_tool_use, useNA = "always")

# 计算减法测试总分
my_data_wash <- my_data_wash %>%
    mutate(
        total_subtraction_score = case_when(
            is.na(subtraction_tool_use) ~ NA_real_,# 辅助工具这项NA还挺多的，要考虑这个吗
            subtraction_tool_use == 1 ~ 0,
            rowSums(is.na(select(., starts_with("subtraction_test_")))) == 5 ~ 0,
            TRUE ~ rowSums(
                cbind(
                    if_else(subtraction_test_1 == 93, 1, 0),
                    if_else(subtraction_test_2 == 86, 1, 0),
                    if_else(subtraction_test_3 == 79, 1, 0),
                    if_else(subtraction_test_4 == 72, 1, 0),
                    if_else(subtraction_test_5 == 65, 1, 0)
                ),
                na.rm = TRUE
            )
        )
    )

# 统计减法测试总分不同取值的数量，包括NA
table(my_data_wash$total_subtraction_score, useNA = "always")


# 计算日期感知总分(NA处理成0)
my_data_wash <- my_data_wash %>%
    mutate(
        final_date_perception_score = rowSums(
            cbind(
                if_else(!is.na(recall_year), 1, 0),
                if_else(!is.na(recall_month), 1, 0),
                if_else(!is.na(recall_day), 1, 0)
            ),
            na.rm = TRUE
        )
    )

# 统计日期感知总分不同取值的数量，包括NA
table(my_data_wash$final_date_perception_score, useNA = "always")


# 计算星期和季节感知总分
my_data_wash <- my_data_wash %>%
    mutate(
        final_week_season_perception_score = rowSums(
            cbind(
                if_else(recall_weekday == 1, 1, if_else(recall_weekday == 2, 0, NA_real_)),
                if_else(recall_season == 1, 1, if_else(recall_season == 2, 0, NA_real_))
            ),
            na.rm = FALSE
        )
    )

# 统计星期和季节感知总分不同取值的数量，包括NA
table(my_data_wash$final_week_season_perception_score, useNA = "always")

# 计算时间感知总分
my_data_wash <- my_data_wash %>%
    mutate(
        final_time_perception_score = final_date_perception_score + final_week_season_perception_score
    )

# 统计时间感知总分不同取值的数量，包括NA
table(my_data_wash$final_time_perception_score, useNA = "always")

# 计算最终绘画得分
my_data_wash <- my_data_wash %>%
    mutate(
        final_drawing_score = case_when(
            drawing_test == 1 ~ 1,
            drawing_test == 2 ~ 0,
            TRUE ~ NA_real_
        )
    )

# 统计最终绘画得分不同取值的数量，包括NA
table(my_data_wash$final_drawing_score, useNA = "always")

# 认知维度总分计算
my_data_wash <- my_data_wash %>%
    mutate(
        final_cognitive_score = final_recall_score + total_subtraction_score + final_time_perception_score + final_drawing_score
    )

# 统计认知维度总分不同取值的数量，包括NA
table(my_data_wash$final_cognitive_score, useNA = "always")

# 计算认知维度层次
quantiles <- quantile(my_data_wash$final_cognitive_score, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
my_data_wash <- my_data_wash %>%
    mutate(
        cognitive_level = case_when(
            is.na(final_cognitive_score) ~ NA_real_,
            final_cognitive_score <= quantiles[1] ~ 0,
            final_cognitive_score > quantiles[1] & final_cognitive_score <= quantiles[2] ~ 1,
            final_cognitive_score > quantiles[2] & final_cognitive_score <= quantiles[3] ~ 2,
            final_cognitive_score > quantiles[3] ~ 3
        )
    )

# 查看认知维度层次不同取值的数量，包括NA
table(my_data_wash$cognitive_level, useNA = "always")

# 导出认知维度所有变量和ID，去除其他所有变量，导出一个csv
required_columns <- c(
    "ID", "final_recall_score", "total_subtraction_score", "final_time_perception_score", "final_drawing_score", "final_cognitive_score", "cognitive_level"
)
my_data_cognitive <- my_data_wash %>%
    select(all_of(required_columns))

write.csv(my_data_cognitive, "cognitive_dimension_data.csv", row.names = FALSE)
```
### 心理维度计算
```{r 心理维度计算}
# 计算总睡眠时间（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        total_sleep_time = case_when(
            is.na(night_sleep_time) ~ NA_real_,
            TRUE ~ night_sleep_time + coalesce(nap_time / 60, 0)
        )
    )

# 计算睡眠时间分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_sleep_time_score = case_when(
            is.na(total_sleep_time) ~ NA_real_,
            total_sleep_time >= 5 & total_sleep_time <= 10.5 ~ 1,
            TRUE ~ 0
        )
    )

# 查看睡眠时间分数不同取值的数量，包括NA
table(my_data_wash$final_sleep_time_score, useNA = "always")

# 计算不良睡眠频率分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_poor_sleep_score = case_when(
            poor_sleep_frequency %in% c(1, 2) ~ 1,
            poor_sleep_frequency %in% c(3, 4) ~ 0,
            TRUE ~ NA_real_
        )
    )

# 查看不良睡眠频率分数不同取值的数量，包括NA
table(my_data_wash$final_poor_sleep_score, useNA = "always")

# 计算抑郁总分（目前全部NA才算NA，应该一个NA就是NA）
my_data_wash <- my_data_wash %>%
    mutate(
        total_depression_score = if_else(
            rowSums(is.na(select(., starts_with("depression_scale_")))) > 0,
            NA_real_,
            rowSums(
                select(., starts_with("depression_scale_")) %>%
                    mutate_all(~ case_when(
                        . == 1 ~ 0,
                        . == 2 ~ 1,
                        . == 3 ~ 2,
                        . == 4 ~ 3,
                        TRUE ~ 0
                    )) %>%
                    mutate(
                        depression_scale_5 = case_when(
                            depression_scale_5 == 1 ~ 3,
                            depression_scale_5 == 2 ~ 2,
                            depression_scale_5 == 3 ~ 1,
                            depression_scale_5 == 4 ~ 0,
                            TRUE ~ 0
                        ),
                        depression_scale_8 = case_when(
                            depression_scale_8 == 1 ~ 3,
                            depression_scale_8 == 2 ~ 2,
                            depression_scale_8 == 3 ~ 1,
                            depression_scale_8 == 4 ~ 0,
                            TRUE ~ 0
                        )
                    ),
                na.rm = TRUE
            )
        )
    ) %>%
    mutate(
        final_depression_score = case_when(
            is.na(total_depression_score) ~ NA_real_,
            total_depression_score <= 9 ~ 1,
            TRUE ~ 0
        )
    )

# 统计抑郁总分不同取值的数量，包括NA
table(my_data_wash$final_depression_score, useNA = "always")

# 心理维度总分计算
my_data_wash <- my_data_wash %>%
    mutate(
        final_psychological_score = rowSums(select(., final_sleep_time_score, final_poor_sleep_score, final_depression_score), na.rm = FALSE)
    )

# 统计心理维度总分不同取值的数量，包括NA
table(my_data_wash$final_psychological_score, useNA = "always")

# 导出心理维度所有变量和ID，去除其他所有变量，导出一个csv
required_columns <- c(
    "ID", "total_sleep_time", "final_sleep_time_score", "final_poor_sleep_score", "final_depression_score", "final_psychological_score",
    "depression_scale_1", "depression_scale_2", "depression_scale_3", "depression_scale_4", "depression_scale_5", "depression_scale_6",
    "depression_scale_7", "depression_scale_8", "depression_scale_9"
)
my_data_psychological <- my_data_wash %>%
    select(all_of(required_columns))

write.csv(my_data_psychological, "psychological_dimension_data.csv", row.names = FALSE)
```
### 感官维度计算(无误)
```{r 感官维度计算}
# 计算视力总分（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_far_vision = case_when(
            wearing_glasses %in% c(1, 2) ~ 0,
            wearing_glasses %in% c(3, 4) ~ case_when(
                far_vision %in% c(1, 2, 3, 4) ~ 1,
                far_vision == 5 ~ 0,
                TRUE ~ NA_real_
            ),
            TRUE ~ NA_real_
        ),
        final_near_vision = case_when(
            wearing_glasses %in% c(1, 2) ~ 0,
            wearing_glasses %in% c(3, 4) ~ case_when(
                near_vision %in% c(1, 2, 3, 4) ~ 1,
                near_vision == 5 ~ 0,
                TRUE ~ NA_real_
            ),
            TRUE ~ NA_real_
        )
    )

# 统计视力总分不同取值的数量，包括NA
table(my_data_wash$final_far_vision, useNA = "always")
table(my_data_wash$final_near_vision, useNA = "always")

# 计算听力总分（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_hearing_score = case_when(
            hearing_aid == 1 ~ 0,
            hearing_aid == 2 ~ case_when(
                hearing_status %in% c(1, 2, 3, 4) ~ 1,
                hearing_status == 5 ~ 0,
                TRUE ~ NA_real_
            ),
            TRUE ~ NA_real_
        )
    )
# 统计听力总分不同取值的数量，包括NA
table(my_data_wash$final_hearing_score, useNA = "always")

# 计算感官维度总分
my_data_wash <- my_data_wash %>%
    mutate(
        final_sensory_score = rowSums(select(., final_far_vision, final_near_vision, final_hearing_score), na.rm = FALSE)
    )
# 统计感官维度总分不同取值的数量，包括NA
table(my_data_wash$final_sensory_score, useNA = "always")

# 导出感官维度所有变量和ID，去除其他所有变量，导出一个csv
required_columns <- c(
    "ID", "final_far_vision", "final_near_vision", "final_hearing_score", "final_sensory_score"
)
my_data_sensory <- my_data_wash %>%
    select(all_of(required_columns))

write.csv(my_data_sensory, "sensory_dimension_data.csv", row.names = FALSE)
```
### 活力维度计算（无误，性别没有的也都没法衡量，为NA）
```{r 活力维度计算}
# 计算左手握力分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_left_hand_grip = case_when(
            left_hand_grip_1 == 993 & left_hand_grip_2 == 993 ~ 0,
            (is.na(left_hand_grip_1) & is.na(left_hand_grip_2)) | (left_hand_grip_1 == 999 & left_hand_grip_2 == 999) | (is.na(left_hand_grip_1) & left_hand_grip_2 == 999) | (left_hand_grip_1 == 999 & is.na(left_hand_grip_2)) ~ case_when(
                rowSums(select(., starts_with("grip_test_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("grip_test_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            TRUE ~ pmax(left_hand_grip_1, left_hand_grip_2, na.rm = TRUE)
        )
    )

# 计算右手握力分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_right_hand_grip = case_when(
            right_hand_grip_1 == 993 & right_hand_grip_2 == 993 ~ 0,
            (is.na(right_hand_grip_1) & is.na(right_hand_grip_2)) | (right_hand_grip_1 == 999 & right_hand_grip_2 == 999) | (is.na(right_hand_grip_1) & right_hand_grip_2 == 999) | (right_hand_grip_1 == 999 & is.na(right_hand_grip_2)) ~ case_when(
                rowSums(select(., starts_with("grip_test_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("grip_test_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            TRUE ~ pmax(right_hand_grip_1, right_hand_grip_2, na.rm = TRUE)
        )
    )

# 计算最终握力分数（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_grip_score = case_when(
            gender == 1 ~ if_else(pmax(final_left_hand_grip, final_right_hand_grip, na.rm = TRUE) >= 35, 1, 0),
            gender == 2 ~ if_else(pmax(final_left_hand_grip, final_right_hand_grip, na.rm = TRUE) >= 25, 1, 0),
            TRUE ~ NA_real_ # 性别没法获取的时候这个也没法赋值
        )
    )

# 统计握力分数不同取值的数量，包括NA
table(my_data_wash$final_grip_score, useNA = "always")

# 计算呼吸功能总分（无误）
my_data_wash <- my_data_wash %>%
    mutate(
        final_breath_test = case_when(
            rowSums(select(., starts_with("breath_test_")) == 993, na.rm = TRUE) == 3 ~ 0,
            rowSums(is.na(select(., starts_with("breath_test_"))) | select(., starts_with("breath_test_")) == 999, na.rm = TRUE) == 3 ~ case_when(
                rowSums(select(., starts_with("breath_test_reason_")) == 4, na.rm = TRUE) > 0 ~ 0,
                rowSums(select(., starts_with("breath_test_reason_")) == 6, na.rm = TRUE) > 0 ~ 0,
                TRUE ~ NA_real_
            ),
            TRUE ~ case_when(
                gender == 1 ~ if_else(pmax(breath_test_1, breath_test_2, breath_test_3, na.rm = TRUE) >= 400, 1, 0),
                gender == 2 ~ if_else(pmax(breath_test_1, breath_test_2, breath_test_3, na.rm = TRUE) >= 290, 1, 0),
                TRUE ~ NA_real_
            )
        )
    )

# 统计呼吸功能分数不同取值的数量，包括NA
table(my_data_wash$final_breath_test, useNA = "always")

# 计算血红蛋白分数（算法无误，但不知道上界和下界算不算正常值）
my_data_wash <- my_data_wash %>%
    mutate(
        final_hemoglobin_score = case_when(
            is.na(hemoglobin) ~ NA_real_,
            gender == 1 & hemoglobin * 10 >= 120 & hemoglobin * 10 <= 160 ~ 1,
            gender == 1 & (hemoglobin * 10 < 120 | hemoglobin * 10 > 160) ~ 0,
            gender == 2 & hemoglobin * 10 >= 110 & hemoglobin * 10 <= 150 ~ 1,
            gender == 2 & (hemoglobin * 10 < 110 | hemoglobin * 10 > 150) ~ 0,
            TRUE ~ NA_real_
        )
    )

# 统计血红蛋白分数不同取值的数量，包括NA
table(my_data_wash$final_hemoglobin_score, useNA = "always")    


# 计算活力维度总分
my_data_wash <- my_data_wash %>%
    mutate(
        final_vitality_score = rowSums(select(., final_grip_score, final_breath_test, final_hemoglobin_score), na.rm = FALSE)
    )

# 统计活力维度总分不同取值的数量，包括NA
table(my_data_wash$final_vitality_score, useNA = "always")

# 导出活力维度所有变量和ID，去除其他所有变量，导出一个csv
required_columns <- c(
    "ID", "final_left_hand_grip", "final_right_hand_grip", "final_grip_score", "final_breath_test", "final_hemoglobin_score", "final_vitality_score"
)
my_data_vitality <- my_data_wash %>%select(all_of(required_columns))
write.csv(my_data_vitality, "vitality_dimension_data.csv", row.names = FALSE)

```
## 内在能力清洗
```{r 内在能力清洗}
# 挑出只包含ID和五个内在能力维度总分的变量
final_ic_scores <- my_data_wash %>%
    select(ID, final_physical_score, cognitive_level, final_psychological_score, final_sensory_score, final_vitality_score)

# 导出包含所有内在能力维度总分的数据
write.csv(final_ic_scores, "final_ic_scores.csv", row.names = FALSE)

# 计算覆盖百分之百内在能力变量的个体数量
covered_individuals <- final_ic_scores %>%
    filter(!is.na(final_physical_score) & !is.na(cognitive_level) & !is.na(final_psychological_score) & !is.na(final_sensory_score) & !is.na(final_vitality_score))
write.csv(covered_individuals, "covered_individuals.csv", row.names = FALSE)

# 输出覆盖百分之百内在能力变量的个体数量
covered_count <- nrow(covered_individuals)
print(paste("覆盖百分之百内在能力变量的个体数量:", covered_count))

# 导出覆盖100%的个体数据导出为csv
my_data_filtered_100_ic <- my_data_wash %>%
    filter(ID %in% covered_individuals$ID)
write.csv(my_data_filtered_100_ic, "filtered_data_100_ic.csv", row.names = FALSE)

# 统计覆盖80%内在能力变量的个体数量
covered_80_percent_individuals <- final_ic_scores %>%
    filter(rowSums(!is.na(select(., final_physical_score, cognitive_level, final_psychological_score, final_sensory_score, final_vitality_score))) >= 4)
write.csv(covered_80_percent_individuals, "covered_80_percent_individuals.csv", row.names = FALSE)

# 统计下这些个体中每个内在能力维度到底缺多少
missing_counts <- covered_80_percent_individuals %>%
    summarise(
        missing_physical = sum(is.na(final_physical_score)),
        missing_cognitive = sum(is.na(cognitive_level)),
        missing_psychological = sum(is.na(final_psychological_score)),
        missing_sensory = sum(is.na(final_sensory_score)),
        missing_vitality = sum(is.na(final_vitality_score))
    )

print(missing_counts)


# 输出覆盖80%内在能力变量的个体数量
covered_80_percent_count <- nrow(covered_80_percent_individuals)
print(paste("覆盖80%内在能力变量的个体数量:", covered_80_percent_count))

# 导出覆盖80%内在能力变量的个体数据
my_data_filtered_80_percent_ic <- my_data_wash %>%
    filter(ID %in% covered_80_percent_individuals$ID)

write.csv(my_data_filtered_80_percent_ic, "filtered_data_80_percent_ic.csv", row.names = FALSE)
```
## 自变量筛选

## 数据分割
## 模型构建

## 模型验证